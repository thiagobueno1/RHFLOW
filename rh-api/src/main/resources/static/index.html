<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RH - Painel</title>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --card:#111827;      /* gray-900 */
      --muted:#9ca3af;     /* gray-400 */
      --text:#e5e7eb;      /* gray-200 */
      --brand:#6366f1;     /* indigo-500 */
      --accent:#10b981;    /* emerald-500 */
      --warn:#f59e0b;      /* amber-500 */
      --bad:#ef4444;       /* red-500 */
      --ok:#22c55e;        /* green-500 */
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:linear-gradient(180deg,#0b1222 0%, #0f172a 100%); color:var(--text);
      font-family: ui-sans-serif,system-ui,Arial; -webkit-font-smoothing:antialiased;
    }
    header{position:sticky;top:0;background:rgba(15,23,42,.8);backdrop-filter:blur(8px);z-index:5;border-bottom:1px solid #1f2937}
    header .wrap{max-width:1080px;margin:auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0;color:#fff;letter-spacing:.3px}
    main{max-width:1080px;margin:24px auto;padding:0 16px;display:grid;gap:16px}
    .card{
      background:linear-gradient(180deg,#0f172a 0%, #0b1120 100%);
      border:1px solid rgba(99,102,241,.2);
      border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    .title{display:flex;align-items:center;gap:10px;margin:0 0 12px}
    .title .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .row{display:grid;gap:12px}
    @media(min-width:760px){.row{grid-template-columns:1fr 1fr}}
    label{display:block;color:var(--muted);font-size:13px;margin:6px 0}
    input,select{
      width:100%;padding:12px;border-radius:12px;border:1px solid #223;outline:none;background:#0b1222;color:var(--text)
    }
    input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(99,102,241,.15)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;color:#fff;transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .btn.brand{background:linear-gradient(90deg,#6366f1,#8b5cf6)}
    .btn.accent{background:linear-gradient(90deg,#10b981,#22c55e)}
    .btn.warn{background:linear-gradient(90deg,#f59e0b,#f97316)}
    .btn.bad{background:linear-gradient(90deg,#ef4444,#dc2626)}
    .btn.ghost{background:#0b1222;border:1px solid #1f2937;color:var(--muted)}
    .muted{color:var(--muted);font-size:12px}

    .clock{font-size:36px;font-weight:800;letter-spacing:2px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #273043;background:#0b1222}
    .pill.ok{border-color:rgba(34,197,94,.25);color:#bbf7d0}
    .pill.bad{border-color:rgba(239,68,68,.25);color:#fecaca}
    .pill.info{border-color:rgba(99,102,241,.25);color:#c7d2fe}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #1f2937;font-size:14px}
    th{color:#c7d2fe;text-transform:uppercase;letter-spacing:.04em;font-size:12px}
    tr:hover td{background:#0b1222}
    .right{text-align:right}
    .bad-txt{color:#fecaca}
    .ok-txt{color:#bbf7d0}
    .subgrid{display:grid;gap:12px}
    @media(min-width:960px){.subgrid{grid-template-columns:2fr 1fr}}
    .kpis{display:flex;gap:10px;flex-wrap:wrap}

    /* Aceite box */
    .box{
      border:1px solid #1f2937;background:#0b1222;border-radius:12px;padding:14px
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>RH — Painel</h1>
    <span id="me" class="muted"></span>
  </div>
</header>

<main>

  <!-- Login -->
  <section class="card">
    <h3 class="title"><span class="dot"></span>Login</h3>
    <div class="row">
      <div><label>Email</label><input id="email" placeholder="ana@empresa.com"></div>
      <div><label>Senha (CPF só números)</label><input id="senha" type="password" placeholder="12345678900"></div>
    </div>
    <div class="actions">
      <button class="btn brand" onclick="login()">Entrar</button>
      <button class="btn ghost" onclick="logout()">Sair</button>
    </div>
  </section>

  <!-- Aceite de Relatório Mensal -->
  <section class="card">
    <h3 class="title"><span class="dot"></span>Aceite de Relatório Mensal</h3>

    <div class="row">
      <div>
        <label>Competência (YYYY-MM)</label>
        <input id="aceite_comp" placeholder="YYYY-MM">
      </div>
      <div style="align-self:end">
        <div class="actions" style="margin-top:0">
          <button class="btn ghost" onclick="checkAceite()">Atualizar status</button>
        </div>
      </div>
    </div>

    <div id="aceiteBox" class="box" style="margin-top:10px">
      <p class="muted" id="aceiteMsg">Faça login para verificar pendências.</p>
      <div class="actions" id="aceiteBtns" style="display:none">
        <button class="btn accent" onclick="decidirAceite(true)">Estou de acordo</button>
        <button class="btn bad" onclick="decidirAceite(false)">Não estou de acordo</button>
      </div>
    </div>
  </section>

  <!-- Painel rápido -->
  <section class="card">
    <h3 class="title"><span class="dot"></span>Painel de Batida</h3>
    <div class="subgrid">
      <div>
        <div class="clock" id="relogio">--:--:--</div>
        <div class="actions" style="margin-top:10px">
          <input id="bp_data" type="date" />
          <label class="pill info"><input type="checkbox" id="bp_geo" style="accent-color:#6366f1"> Enviar minha localização</label>
          <button class="btn accent" onclick="baterPonto()">BATER PONTO</button>
          <span id="bp_msg" class="muted"></span>
        </div>
      </div>
      <div>
        <div class="kpis">
          <span class="pill info" id="kpi-batidas">Batidas hoje: 0</span>
          <span class="pill ok" id="kpi-ferias">Férias: -- dias</span>
          <span class="pill bad" id="kpi-banco">Banco: --</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Registro manual -->
  <section class="card">
    <h3 class="title"><span class="dot"></span>Registro de Ponto (manual)</h3>
    <div class="row">
      <div><label>Colaborador ID</label><input id="p_colab" value="1"></div>
      <div><label>Data</label><input id="p_data" type="date"></div>
      <div><label>Entrada</label><input id="p_e" type="time" value="08:00"></div>
      <div><label>Início Almoço</label><input id="p_ia" type="time" value="12:00"></div>
      <div><label>Fim Almoço</label><input id="p_fa" type="time" value="13:00"></div>
      <div><label>Saída</label><input id="p_s" type="time" value="17:00"></div>
    </div>
    <div class="actions">
      <button class="btn brand" onclick="baterPontoManual()">Bater Ponto</button>
      <button class="btn ghost" onclick="listarPontos()">Listar Semana</button>
      <span id="p_msg" class="muted"></span>
    </div>
    <div id="pontosTabela"></div>
  </section>

  <!-- Banco de horas -->
  <section class="card">
    <h3 class="title"><span class="dot"></span>Banco de Horas</h3>
    <div class="row">
      <div><label>Colaborador ID</label><input id="b_colab" value="1"></div>
      <div><label>Competência (YYYY-MM)</label><input id="b_comp" value="2025-08"></div>
      <div><label>De</label><input id="b_de" type="date"></div>
      <div><label>Até</label><input id="b_ate" type="date"></div>
    </div>
    <div class="actions">
      <button class="btn brand" onclick="recalcular()">Recalcular Mês</button>
      <button class="btn accent" onclick="extrato()">Extrato</button>
      <button class="btn warn" onclick="baixarCSV()">Relatório CSV</button>
      <span id="b_msg" class="muted"></span>
    </div>
    <div id="resumos" class="kpis" style="margin-top:8px"></div>
    <div id="extratoTabela"></div>
  </section>

</main>

<script>
let token=null, me=null;
const Z = new Intl.DateTimeFormat('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});

function tick(){
  document.getElementById('relogio').innerText = Z.format(new Date());
  requestAnimationFrame(()=>setTimeout(tick,800));
}
tick();

function authHeaders(){
  return token? { "Authorization":"Bearer "+token, "Content-Type":"application/json" } : {"Content-Type":"application/json"};
}

function ymNow(){
  const d = new Date();
  const m = (d.getMonth()+1).toString().padStart(2,'0');
  return `${d.getFullYear()}-${m}`;
}

async function login(){
  const email=document.getElementById('email').value.trim();
  const senha=document.getElementById('senha').value.trim();
  const r=await fetch('/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,senha})});
  if(!r.ok){ document.getElementById('me').innerText='Falha no login'; return; }
  const data=await r.json();
  token=data.token; me=data;
  document.getElementById('me').innerText=`Logado: ${data.nome} (${data.role})`;

  // seta competência padrão do aceite para o mês atual
  document.getElementById('aceite_comp').value = ymNow();

  // verifica aceite imediatamente
  checkAceite();
}

function logout(){ token=null; me=null; document.getElementById('me').innerText=''; document.getElementById('aceiteMsg').innerText='Faça login para verificar pendências.'; document.getElementById('aceiteBtns').style.display='none'; }

function minutesToHHMM(min){
  const sign = min<0 ? '-' : '';
  const abs = Math.abs(min);
  const h = Math.floor(abs/60).toString().padStart(2,'0');
  const m = (abs%60).toString().padStart(2,'0');
  return `${sign}${h}:${m}`;
}

/* ================== Aceite Mensal ================== */

async function checkAceite(){
  const msg = document.getElementById('aceiteMsg');
  const btns = document.getElementById('aceiteBtns');
  if(!token){ msg.innerText='Faça login para verificar pendências.'; btns.style.display='none'; return; }

  const comp = (document.getElementById('aceite_comp').value || ymNow()).trim();
  if(!/^\d{4}-\d{2}$/.test(comp)){ msg.innerText='Competência inválida (use YYYY-MM)'; btns.style.display='none'; return; }

  try{
    const r = await fetch(`/assinaturas-mensais/status?competencia=${encodeURIComponent(comp)}`, { headers: authHeaders() });
    if(!r.ok){
      const t = await r.text();
      msg.innerText = `Não foi possível consultar o status (${r.status}). ${t||''}`;
      btns.style.display='none';
      return;
    }
    const j = await r.json();
    const status = (j.status||'').toUpperCase();
    // tenta ler pendência do anterior; se não vier no JSON, tenta fallback
    let pendAnterior = (typeof j.pendenciaAnterior === 'boolean') ? j.pendenciaAnterior : null;

    if(pendAnterior === null){
      try {
        const rp = await fetch(`/assinaturas-mensais/tem-pendencia-anterior?competencia=${encodeURIComponent(comp)}`, { headers: authHeaders() });
        if(rp.ok){
          const jp = await rp.json();
          // aceita tanto {pendenciaAnterior:true/false} quanto um boolean direto
          pendAnterior = (typeof jp === 'boolean') ? jp : !!jp.pendenciaAnterior;
        }
      } catch(e){}
    }

    if(status === 'PENDENTE'){
      if(pendAnterior){
        msg.innerHTML = `Você possui pendências do mês anterior. <br><span class="muted">Regularize primeiro o mês anterior para poder decidir a competência ${comp}.</span>`;
        btns.style.display='none';
      }else{
        msg.innerHTML = `Você confirma que leu e concorda com o relatório da competência <b>${comp}</b>?`;
        btns.style.display='flex';
      }
    } else if(status === 'ASSINADO'){
      msg.innerHTML = `Tudo certo! Relatório de <b>${comp}</b> está <span class="pill ok" style="border:none">ASSINADO</span>.`;
      btns.style.display='none';
    } else if(status === 'RECUSADO'){
      msg.innerHTML = `Relatório de <b>${comp}</b> foi <span class="pill bad" style="border:none">RECUSADO</span>. Aguarde contato do RH.`;
      btns.style.display='none';
    } else {
      msg.innerText = `Sem pendências de aceite no momento.`;
      btns.style.display='none';
    }
  }catch(e){
    msg.innerText = 'Erro ao consultar status: '+e;
    btns.style.display='none';
  }
}

async function decidirAceite(aceita){
  const msg = document.getElementById('aceiteMsg');
  const btns = document.getElementById('aceiteBtns');
  if(!token){ alert('Faça login'); return; }
  const comp = (document.getElementById('aceite_comp').value || ymNow()).trim();

  try{
    const r = await fetch('/assinaturas-mensais/decidir', {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify({ competencia: comp, aceita })
    });
    const t = await r.text();
    if(r.ok){
      msg.innerText = aceita ? 'Assinatura registrada com sucesso.' : 'Recusa registrada com sucesso.';
      btns.style.display='none';
      // reconsulta para refletir status final
      checkAceite();
    } else {
      msg.innerText = `Não foi possível registrar decisão (${r.status}): ${t}`;
    }
  }catch(e){
    msg.innerText = 'Erro ao enviar decisão: '+e;
  }
}

/* ================== Batida, Extrato, etc. (seu código original) ================== */

async function baterPonto(){
  if(!token){ alert('Faça login'); return; }
  const body={ data: document.getElementById('bp_data').value || null };
  const wantGeo = document.getElementById('bp_geo').checked;
  let geo = null;
  if(wantGeo && navigator.geolocation){
    try{
      geo = await new Promise((ok,err)=>navigator.geolocation.getCurrentPosition(p=>ok(p.coords),err,{enableHighAccuracy:true,timeout:4000}));
    }catch(e){}
  }
  if(geo){
    body.lat = geo.latitude;
    body.lng = geo.longitude;
  }

  const res = await fetch('/pontos/bater',{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});
  const txt = await res.text();
  document.getElementById('bp_msg').innerText = res.ok ? 'Batida registrada!' : ('Erro '+res.status+': '+txt);
  try{
    const r = await fetch(`/pontos/hoje`,{headers:authHeaders()});
    if(r.ok){
      const j = await r.json();
      document.getElementById('kpi-batidas').innerText = `Batidas hoje: ${j.batidas||0}`;
    }
  }catch(e){}
}

async function baterPontoManual(){
  const body={
    colaboradorId: +document.getElementById('p_colab').value,
    data: document.getElementById('p_data').value,
    horaEntrada: document.getElementById('p_e').value ? document.getElementById('p_e').value+":00" : null,
    inicioAlmoco: document.getElementById('p_ia').value ? document.getElementById('p_ia').value+":00" : null,
    fimAlmoco: document.getElementById('p_fa').value ? document.getElementById('p_fa').value+":00" : null,
    horaSaida: document.getElementById('p_s').value ? document.getElementById('p_s').value+":00" : null,
    origem: "MANUAL",
    observacao: "Front"
  };
  const r=await fetch('/pontos',{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});
  document.getElementById('p_msg').innerText = r.ok? 'OK' : 'Erro '+r.status;
}

async function listarPontos(){
  const id=+document.getElementById('p_colab').value;
  const de=new Date(); de.setDate(de.getDate()-7);
  const ate=new Date();
  const url=`/pontos?colaboradorId=${id}&de=${de.toISOString().slice(0,10)}&ate=${ate.toISOString().slice(0,10)}`;
  const r=await fetch(url,{headers:authHeaders()});
  const arr= r.ok? await r.json(): [];
  renderTabela('pontosTabela', arr, ['data','horaEntrada','inicioAlmoco','fimAlmoco','horaSaida','origem']);
}

async function recalcular(){
  const id=+document.getElementById('b_colab').value;
  const comp=document.getElementById('b_comp').value;
  const r=await fetch(`/banco-horas/recalcular?colaboradorId=${id}&competencia=${comp}`,{method:'POST',headers:authHeaders()});
  const j= await r.json();
  document.getElementById('b_msg').innerText = r.ok? `Saldo mês: ${j.saldoMinutos} min (${minutesToHHMM(j.saldoMinutos)})` : 'Erro '+r.status;
}

async function extrato(){
  const id=+document.getElementById('b_colab').value;
  const de=document.getElementById('b_de').value;
  const ate=document.getElementById('b_ate').value;
  const r=await fetch(`/banco-horas/extrato?colaboradorId=${id}&de=${de}&ate=${ate}`,{headers:authHeaders()});
  const j= await r.json();
  renderTabela('extratoTabela', j.dias, ['data','previstoMin','trabalhadoMin','saldoMin']);

  const resumos = document.getElementById('resumos');
  resumos.innerHTML = `
    <span class="pill info">Saldo período: ${j.saldoTotalMin} min (${minutesToHHMM(j.saldoTotalMin)})</span>
    <span class="pill ${j.bancoAcumuladoMin<0?'bad':'ok'}">Banco acumulado: ${j.bancoAcumuladoMin} min (${minutesToHHMM(j.bancoAcumuladoMin)})</span>
    <span class="pill ok">Saldo de férias: ${j.saldoFeriasDias} dias</span>
  `;

  document.getElementById('kpi-ferias').innerText = `Férias: ${j.saldoFeriasDias} dias`;
  document.getElementById('kpi-banco').innerText = `Banco: ${minutesToHHMM(j.bancoAcumuladoMin)}`;
  document.getElementById('b_msg').innerText = '';
}

function baixarCSV(){
  const table = document.querySelector('#extratoTabela table');
  if(!table){ alert('Faça o extrato primeiro'); return; }

  let csv = 'data,previstoMin,trabalhadoMin,saldoMin\n';
  table.querySelectorAll('tbody tr').forEach(tr=>{
    const tds=[...tr.children].map(td=>td.innerText.replaceAll('"','""'));
    csv += `"${tds[0]}","${tds[1]}","${tds[2]}","${tds[3]}"\n`;
  });

  const kpis = document.getElementById('resumos').innerText.replace(/\s+/g,' ').trim();
  csv += `\n"RESUMO","${kpis}","",""\n`;

  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='extrato.csv'; a.click();
}

function renderTabela(containerId, data, cols){
  const el=document.getElementById(containerId);
  if(!data || !data.length){ el.innerHTML='<p class="muted">Sem dados.</p>'; return; }
  const head = '<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
  const rows = data.map(o=>{
    const tds = cols.map(c=>{
      let v = (o[c]??'');
      if(['previstoMin','trabalhadoMin','saldoMin'].includes(c)) {
        const cls = (c==='saldoMin' ? (v<0?'bad-txt':'ok-txt') : '');
        return `<td class="right ${cls}">${v} (${minutesToHHMM(v)})</td>`;
      }
      return `<td>${v}</td>`;
    }).join('');
    return `<tr>${tds}</tr>`;
  }).join('');
  el.innerHTML = `<table>${head}<tbody>${rows}</tbody></table>`;
}
</script>
</body>
</html>
