<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RH - Painel</title>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --muted:#9ca3af;
      --text:#e5e7eb;
      --brand:#6366f1;
      --accent:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:linear-gradient(180deg,#0b1222 0%, #0f172a 100%); color:var(--text);
      font-family: ui-sans-serif,system-ui,Arial; -webkit-font-smoothing:antialiased;
    }
    header{position:sticky;top:0;background:rgba(15,23,42,.8);backdrop-filter:blur(8px);z-index:5;border-bottom:1px solid #1f2937}
    header .wrap{max-width:1080px;margin:auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0;color:#fff;letter-spacing:.3px}
    main{max-width:1080px;margin:24px auto;padding:0 16px;display:grid;gap:16px}
    .card{
      background:linear-gradient(180deg,#0f172a 0%, #0b1120 100%);
      border:1px solid rgba(99,102,241,.2);
      border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    .title{display:flex;align-items:center;gap:10px;margin:0 0 12px}
    .title .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .row{display:grid;gap:12px}
    @media(min-width:760px){.row{grid-template-columns:1fr 1fr}}
    label{display:block;color:var(--muted);font-size:13px;margin:6px 0}
    input,select{
      width:100%;padding:12px;border-radius:12px;border:1px solid #223;outline:none;background:#0b1222;color:var(--text)
    }
    input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(99,102,241,.15)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;color:#fff;transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .btn.brand{background:linear-gradient(90deg,#6366f1,#8b5cf6)}
    .btn.accent{background:linear-gradient(90deg,#10b981,#22c55e)}
    .btn.warn{background:linear-gradient(90deg,#f59e0b,#f97316)}
    .btn.bad{background:linear-gradient(90deg,#ef4444,#dc2626)}
    .btn.ghost{background:#0b1222;border:1px solid #1f2937;color:var(--muted)}
    .muted{color:var(--muted);font-size:12px}
    .clock{font-size:36px;font-weight:800;letter-spacing:2px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #273043;background:#0b1222}
    .pill.ok{border-color:rgba(34,197,94,.25);color:#bbf7d0}
    .pill.bad{border-color:rgba(239,68,68,.25);color:#fecaca}
    .pill.info{border-color:rgba(99,102,241,.25);color:#c7d2fe}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #1f2937;font-size:14px}
    th{color:#c7d2fe;text-transform:uppercase;letter-spacing:.04em;font-size:12px}
    tr:hover td{background:#0b1222}
    .right{text-align:right}
    .bad-txt{color:#fecaca}
    .ok-txt{color:#bbf7d0}
    .subgrid{display:grid;gap:12px}
    @media(min-width:960px){.subgrid{grid-template-columns:2fr 1fr}}
    .kpis{display:flex;gap:10px;flex-wrap:wrap}
    .box{border:1px solid #1f2937;background:#0b1222;border-radius:12px;padding:14px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>RH — Painel</h1>
    <span id="me" class="muted"></span>
  </div>
</header>

<main>

  <!-- Login -->
  <section class="card">
    <h3 class="title"><span class="dot"></span>Login</h3>
    <div class="row">
      <div><label>Email</label><input id="email" placeholder="ana@empresa.com"></div>
      <div><label>Senha (CPF só números)</label><input id="senha" type="password" placeholder="12345678900"></div>
    </div>
    <div class="actions">
      <button class="btn brand" onclick="login()">Entrar</button>
      <button class="btn ghost" onclick="logout()">Sair</button>
    </div>
  </section>

  <!-- Aceite -->
  <section class="card">
    <h3 class="title"><span class="dot"></span>Aceite de Relatório Mensal</h3>
    <div class="row">
      <div><label>Competência (YYYY-MM)</label><input id="aceite_comp" placeholder="YYYY-MM"></div>
      <div style="align-self:end"><div class="actions" style="margin-top:0"><button class="btn ghost" onclick="checkAceite()">Atualizar status</button></div></div>
    </div>
    <div id="aceiteBox" class="box" style="margin-top:10px">
      <p class="muted" id="aceiteMsg">Faça login para verificar pendências.</p>
      <div class="actions" id="aceiteBtns" style="display:none">
        <button class="btn accent" onclick="decidirAceite(true)">Estou de acordo</button>
        <button class="btn bad" onclick="decidirAceite(false)">Não estou de acordo</button>
      </div>
    </div>
  </section>

  <!-- Painel -->
  <section class="card">
    <h3 class="title"><span class="dot"></span>Painel de Batida</h3>
    <div class="subgrid">
      <div>
        <div class="clock" id="relogio">--:--:--</div>
        <div class="actions" style="margin-top:10px">
          <input id="bp_data" type="date" />
          <label class="pill info"><input type="checkbox" id="bp_geo" style="accent-color:#6366f1"> Enviar minha localização</label>
          <button class="btn accent" onclick="baterPonto()">BATER PONTO</button>
          <span id="bp_msg" class="muted"></span>
        </div>
      </div>
      <div>
        <div class="kpis">
          <span class="pill info" id="kpi-batidas">Batidas hoje: 0</span>
          <span class="pill ok" id="kpi-ferias">Férias: -- dias</span>
          <span class="pill bad" id="kpi-banco">Banco: --</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Registro manual -->
  <section class="card">
    <h3 class="title"><span class="dot"></span>Registro de Ponto (manual)</h3>
    <div class="row">
      <div><label>Colaborador ID</label><input id="p_colab" value="1"></div>
      <div><label>Data</label><input id="p_data" type="date"></div>
      <div><label>Entrada</label><input id="p_e" type="time" value="08:00"></div>
      <div><label>Início Almoço</label><input id="p_ia" type="time" value="12:00"></div>
      <div><label>Fim Almoço</label><input id="p_fa" type="time" value="13:00"></div>
      <div><label>Saída</label><input id="p_s" type="time" value="17:00"></div>
    </div>
    <div class="actions">
      <button class="btn brand" onclick="baterPontoManual()">Bater Ponto</button>
      <button class="btn ghost" onclick="listarPontos()">Listar Semana</button>
      <span id="p_msg" class="muted"></span>
    </div>
    <div id="pontosTabela"></div>
  </section>

  <!-- Banco de Horas -->
  <section class="card">
    <h3 class="title"><span class="dot"></span>Banco de Horas</h3>
    <div class="row">
      <div><label>Colaborador ID</label><input id="b_colab" value="1"></div>
      <div><label>Competência (YYYY-MM)</label><input id="b_comp" value="2025-08"></div>
      <div><label>De</label><input id="b_de" type="date"></div>
      <div><label>Até</label><input id="b_ate" type="date"></div>
    </div>
    <div class="actions">
      <button class="btn accent" onclick="extrato()">Extrato</button>
      <button class="btn warn" onclick="baixarCSV()">Relatório CSV</button>
      <span id="b_msg" class="muted"></span>
    </div>
    <div id="resumos" class="kpis" style="margin-top:8px"></div>
    <div id="extratoTabela"></div>
  </section>

</main>

<script>
let token = null, me = null;
const Z = new Intl.DateTimeFormat('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});

function tick(){
  document.getElementById('relogio').innerText = Z.format(new Date());
  requestAnimationFrame(() => setTimeout(tick, 800));
}
tick();

function authHeaders(){
  return token
    ? { "Authorization": "Bearer " + token, "Content-Type": "application/json" }
    : { "Content-Type": "application/json" };
}

function ymPrev(){
  const d = new Date();
  let y = d.getFullYear(), m = d.getMonth(); // 0-11
  if (m === 0) { m = 12; y--; }
  return `${y}-${String(m).padStart(2,'0')}`;
}

function logout(){
  token = null;
  me = null;
  document.getElementById('me').innerText = '';
  document.getElementById('aceiteMsg').innerText = 'Faça login para verificar pendências.';
  document.getElementById('aceiteBtns').style.display = 'none';
  document.getElementById('kpi-batidas').innerText = 'Batidas hoje: 0';
  document.getElementById('kpi-ferias').innerText = 'Férias: -- dias';
  document.getElementById('kpi-banco').innerText = 'Banco: --';
}

async function login(){
  const email = document.getElementById('email').value.trim();
  const senha = document.getElementById('senha').value.trim();
  const r = await fetch('/auth/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({email,senha})
  });
  if(!r.ok){
    document.getElementById('me').innerText='Falha no login';
    return;
  }
  const data = await r.json();
  token = data.token;
  me = data;
  document.getElementById('me').innerText = `Logado: ${data.nome} (${data.role})`;
  document.getElementById('aceite_comp').value = ymPrev();
  await checkAceite();
  await carregarStatusHoje();
}

function minutesToHHMM(min){
  const s = min < 0 ? '-' : '';
  const a = Math.abs(min);
  const h = Math.floor(a/60).toString().padStart(2,'0');
  const m = (a%60).toString().padStart(2,'0');
  return `${s}${h}:${m}`;
}

function getColaboradorId(){
  if(me && typeof me.colaboradorId === 'number') return me.colaboradorId;
  if(me && typeof me.id === 'number') return me.id;
  const f = (document.getElementById('b_colab')?.value) || (document.getElementById('p_colab')?.value);
  const n = f ? parseInt(f,10) : NaN;
  return Number.isFinite(n) ? n : null;
}

async function checkAceite(){
  const msg = document.getElementById('aceiteMsg');
  const btns = document.getElementById('aceiteBtns');
  if(!token){
    msg.innerText='Faça login para verificar pendências.';
    btns.style.display='none';
    return;
  }
  const comp = (document.getElementById('aceite_comp').value || ymPrev()).trim();
  const colaboradorId = getColaboradorId();
  try{
    const r = await fetch(`/assinaturas-mensais/status?colaboradorId=${colaboradorId}&competencia=${comp}`,{headers:authHeaders()});
    if(!r.ok){
      msg.innerText=`Erro ${r.status}`;
      btns.style.display='none';
      return;
    }
    const j = await r.json();
    const status = (j.status || '').toUpperCase();
    if(status==='PENDENTE'){
      msg.innerHTML = `Você confirma que leu e concorda com o relatório da competência <b>${comp}</b>?`;
      btns.style.display='flex';
    }else if(status==='ASSINADO'){
      msg.innerHTML = `Tudo certo! Relatório <b>${comp}</b> <span class="pill ok" style="border:none">ASSINADO</span>`;
      btns.style.display='none';
    }else if(status==='RECUSADO'){
      msg.innerHTML = `Relatório <b>${comp}</b> <span class="pill bad" style="border:none">RECUSADO</span>`;
      btns.style.display='none';
    }else{
      msg.innerText='Sem pendências.';
      btns.style.display='none';
    }
  }catch(e){
    msg.innerText='Erro ao consultar: '+e;
    btns.style.display='none';
  }
}

async function decidirAceite(aceita){
  const msg = document.getElementById('aceiteMsg');
  const btns = document.getElementById('aceiteBtns');
  if(!token){
    alert('Faça login');
    return;
  }
  const comp = (document.getElementById('aceite_comp').value || ymPrev()).trim();
  const colaboradorId = getColaboradorId();
  try{
    const url = `/assinaturas-mensais/decidir?colaboradorId=${colaboradorId}&competencia=${comp}&aceita=${aceita}`;
    const r = await fetch(url,{method:'POST',headers:authHeaders()});
    const t = await r.text();
    if(r.ok){
      msg.innerText = aceita ? 'Assinatura registrada com sucesso.' : 'Recusa registrada com sucesso.';
      btns.style.display='none';
      await checkAceite();
    }else{
      msg.innerText=`Erro (${r.status}): ${t}`;
    }
  }catch(e){
    msg.innerText='Erro ao enviar decisão: '+e;
  }
}

/* ==== NOVAS FUNÇÕES PARA RESTO DO PAINEL ==== */

function requireLogin(){
  if(!token){
    alert('Faça login antes de usar esta funcionalidade.');
    return false;
  }
  return true;
}

// Atualiza KPIs do dia usando /pontos/status-dia
async function carregarStatusHoje(){
  if(!token) return;
  try{
    const r = await fetch('/pontos/status-dia',{headers:authHeaders()});
    if(!r.ok) return;
    const j = await r.json();
    const batidas = j.batidas ?? 0;
    const faltam = j.faltam ?? 0;
    document.getElementById('kpi-batidas').innerText = `Batidas hoje: ${batidas}`;
    const bancoLabel = document.getElementById('kpi-banco');
    if(faltam === 0){
      bancoLabel.innerText = 'Banco: jornada completa hoje';
    }else{
      bancoLabel.innerText = `Banco: faltam ${faltam} batida(s) hoje`;
    }
  }catch(e){
    console.error('Erro ao carregar status do dia', e);
  }
}

// BOTÃO "BATER PONTO" (usa /pontos/bater)
async function baterPonto(){
  if(!requireLogin()) return;

  const msgEl = document.getElementById('bp_msg');
  msgEl.innerText = 'Registrando ponto...';

  const body = {};
  const dataVal = document.getElementById('bp_data').value;
  if(dataVal) body.data = dataVal;

  if(document.getElementById('bp_geo').checked && navigator.geolocation){
    try{
      const pos = await new Promise((resolve,reject)=>
        navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:true,timeout:5000})
      );
      body.lat = pos.coords.latitude;
      body.lng = pos.coords.longitude;
    }catch(e){
      console.warn('Não foi possível obter geolocalização:', e);
    }
  }

  try{
    const r = await fetch('/pontos/bater',{
      method:'POST',
      headers:authHeaders(),
      body:JSON.stringify(body)
    });

    if(!r.ok){
      const txt = await r.text();
      msgEl.innerText = `Erro ao bater ponto (${r.status}): ${txt}`;
      return;
    }

    const j = await r.json();
    msgEl.innerText = j.mensagem || 'Ponto registrado com sucesso.';
    if(typeof j.batidas === 'number'){
      document.getElementById('kpi-batidas').innerText = `Batidas hoje: ${j.batidas}`;
    }
    await carregarStatusHoje();
  }catch(e){
    msgEl.innerText = 'Erro ao bater ponto: ' + e;
  }
}

// Registro manual: POST /pontos com RegistroPontoCreateDTO
async function baterPontoManual(){
  if(!requireLogin()) return;

  const msgEl = document.getElementById('p_msg');
  msgEl.innerText = 'Enviando...';

  const colaboradorId = parseInt(document.getElementById('p_colab').value,10);
  const data = document.getElementById('p_data').value;
  const entrada = document.getElementById('p_e').value;
  const inicioAlmoco = document.getElementById('p_ia').value;
  const fimAlmoco = document.getElementById('p_fa').value;
  const saida = document.getElementById('p_s').value;

  if(!data || !entrada || !saida){
    msgEl.innerText = 'Preencha pelo menos data, entrada e saída.';
    return;
  }

  // garante HH:mm:ss para compatibilidade com LocalTime
  const toTime = t => t && t.length === 5 ? t + ':00' : t || null;

  const body = {
    colaboradorId,
    data,
    horaEntrada: toTime(entrada),
    inicioAlmoco: toTime(inicioAlmoco),
    fimAlmoco: toTime(fimAlmoco),
    horaSaida: toTime(saida),
    origem: "WEB",
    observacao: 'LANÇAMENTO MANUAL VIA PAINEL'
  };

  try{
    const r = await fetch('/pontos',{
      method:'POST',
      headers:authHeaders(),
      body:JSON.stringify(body)
    });
    const txt = await r.text();
    if(!r.ok){
      msgEl.innerText = `Erro (${r.status}): ${txt}`;
      return;
    }
    msgEl.innerText = 'Registro manual salvo com sucesso.';
  }catch(e){
    msgEl.innerText = 'Erro ao registrar ponto: ' + e;
  }
}

// Listar pontos da semana: GET /pontos?colaboradorId&de&ate
async function listarPontos(){
  if(!requireLogin()) return;

  const colaboradorId = parseInt(document.getElementById('p_colab').value,10) || getColaboradorId();
  const hoje = new Date();
  const diaSemana = hoje.getDay(); // 0 domingo
  const diffSegunda = (diaSemana === 0 ? -6 : 1) - diaSemana;
  const segunda = new Date(hoje);
  segunda.setDate(hoje.getDate() + diffSegunda);

  const de = segunda.toISOString().substring(0,10);
  const ate = hoje.toISOString().substring(0,10);

  const container = document.getElementById('pontosTabela');
  container.innerHTML = '<p class="muted">Carregando lançamentos...</p>';

  try{
    const params = new URLSearchParams({colaboradorId, de, ate});
    const r = await fetch(`/pontos?${params.toString()}`,{headers:authHeaders()});
    if(!r.ok){
      const txt = await r.text();
      container.innerHTML = `<p class="muted">Erro (${r.status}): ${txt}</p>`;
      return;
    }
    const dados = await r.json();
    if(!Array.isArray(dados) || dados.length === 0){
      container.innerHTML = '<p class="muted">Nenhum registro encontrado no período.</p>';
      return;
    }

    let html = '<table><thead><tr><th>Data</th><th>Entrada</th><th>Início Almoço</th><th>Fim Almoço</th><th>Saída</th></tr></thead><tbody>';
    for(const d of dados){
      html += `<tr>
        <td>${d.data || ''}</td>
        <td>${d.horaEntrada || ''}</td>
        <td>${d.inicioAlmoco || ''}</td>
        <td>${d.fimAlmoco || ''}</td>
        <td>${d.horaSaida || ''}</td>
      </tr>`;
    }
    html += '</tbody></table>';
    container.innerHTML = html;
  }catch(e){
    container.innerHTML = '<p class="muted">Erro ao buscar registros: ' + e + '</p>';
  }
}

// Extrato do banco de horas: GET /banco-horas/extrato
async function extrato(){
  if(!requireLogin()) return;

  const colaboradorId = getColaboradorId() ?? parseInt(document.getElementById('b_colab').value,10);
  const competencia = document.getElementById('b_comp').value;
  let de = document.getElementById('b_de').value;
  let ate = document.getElementById('b_ate').value;

  // Se não informar período, calcula pelo mês da competência
  if((!de || !ate)){
    const base = competencia || new Date().toISOString().substring(0,7); // YYYY-MM
    const [yStr,mStr] = base.split('-');
    const y = parseInt(yStr,10);
    const m = parseInt(mStr,10);
    if(!isNaN(y) && !isNaN(m)){
      const first = new Date(y, m-1, 1);
      const last = new Date(y, m, 0);
      de = de || first.toISOString().substring(0,10);
      ate = ate || last.toISOString().substring(0,10);
    }
  }

  const msgEl = document.getElementById('b_msg');
  const resumosEl = document.getElementById('resumos');
  const tabelaEl = document.getElementById('extratoTabela');

  msgEl.innerText = 'Carregando extrato...';
  resumosEl.innerHTML = '';
  tabelaEl.innerHTML = '';

  const params = new URLSearchParams();
  params.set('colaboradorId', colaboradorId);
  params.set('de', de);
  params.set('ate', ate);

  try{
    const r = await fetch(`/banco-horas/extrato?${params.toString()}`,{
      headers:authHeaders()
    });
    if(!r.ok){
      const txt = await r.text();
      msgEl.innerText = `Erro (${r.status}): ${txt}`;
      return;
    }

    const dados = await r.json();
    msgEl.innerText = '';

    const saldoPeriodo = dados.saldoTotalMin ?? 0;
    const bancoAcumulado = dados.bancoAcumuladoMin ?? saldoPeriodo;
    const saldoFeriasDias = dados.saldoFeriasDias ?? 0;

    resumosEl.innerHTML = `
      <span class="pill ok">Saldo período: ${minutesToHHMM(saldoPeriodo)}</span>
      <span class="pill info">Banco acumulado: ${minutesToHHMM(bancoAcumulado)}</span>
      <span class="pill warn">Saldo férias: ${saldoFeriasDias} dia(s)</span>
    `;

    document.getElementById('kpi-ferias').innerText = `Férias: ${saldoFeriasDias} dia(s)`;
    document.getElementById('kpi-banco').innerText = `Banco: ${minutesToHHMM(bancoAcumulado)}`;

    const dias = dados.dias || [];
    if(!Array.isArray(dias) || dias.length === 0){
      tabelaEl.innerHTML = '<p class="muted">Nenhum lançamento no período.</p>';
      return;
    }

    const keys = Object.keys(dias[0]);
    let html = '<table><thead><tr>';
    for(const k of keys){
      html += `<th>${k}</th>`;
    }
    html += '</tr></thead><tbody>';
    for(const d of dias){
      html += '<tr>';
      for(const k of keys){
        const v = d[k];
        html += `<td>${v == null ? '' : v}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody></table>';
    tabelaEl.innerHTML = html;
  }catch(e){
    msgEl.innerText = 'Erro ao carregar extrato: ' + e;
  }
}

// Gera CSV no front a partir do extrato
async function baixarCSV(){
  if(!requireLogin()) return;

  const colaboradorId = getColaboradorId() ?? parseInt(document.getElementById('b_colab').value,10);
  const competencia = document.getElementById('b_comp').value;
  let de = document.getElementById('b_de').value;
  let ate = document.getElementById('b_ate').value;

  if((!de || !ate)){
    const base = competencia || new Date().toISOString().substring(0,7);
    const [yStr,mStr] = base.split('-');
    const y = parseInt(yStr,10);
    const m = parseInt(mStr,10);
    if(!isNaN(y) && !isNaN(m)){
      const first = new Date(y, m-1, 1);
      const last = new Date(y, m, 0);
      de = de || first.toISOString().substring(0,10);
      ate = ate || last.toISOString().substring(0,10);
    }
  }

  const params = new URLSearchParams();
  params.set('colaboradorId', colaboradorId);
  params.set('de', de);
  params.set('ate', ate);

  try{
    const r = await fetch(`/banco-horas/extrato?${params.toString()}`,{
      headers:authHeaders()
    });
    if(!r.ok){
      const txt = await r.text();
      alert(`Erro ao gerar CSV (${r.status}): ${txt}`);
      return;
    }
    const dados = await r.json();
    const dias = dados.dias || [];
    if(!Array.isArray(dias) || dias.length === 0){
      alert('Nenhum lançamento no período para gerar CSV.');
      return;
    }

    const keys = Object.keys(dias[0]);
    let csv = keys.join(';') + '\n';
    for(const d of dias){
      const row = keys.map(k => {
        const v = d[k];
        if(v == null) return '';
        const s = String(v).replace(/"/g,'""');
        return `"${s}"`;
      }).join(';');
      csv += row + '\n';
    }

    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `extrato-banco-horas-${competencia || (de + '_a_' + ate)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }catch(e){
    alert('Erro ao gerar CSV: ' + e);
  }
}
</script>
</body>
</html>
